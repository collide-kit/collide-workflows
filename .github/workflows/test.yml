name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Basic test with default settings
  test-default:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run prepare action
        id: prepare
        uses: ./actions/prepare

      - name: Verify Node.js is installed
        run: node --version

      - name: Verify Yarn is installed
        run: yarn --version

      - name: Verify Yarn version matches package.json
        run: |
          expected=$(node -p "require('./package.json').packageManager.split('@')[1]")
          actual=$(yarn --version)
          if [[ "$actual" != "$expected" ]]; then
            echo "Expected Yarn $expected, got $actual"
            exit 1
          fi
          echo "✅ Yarn version matches: $actual"

      - name: Verify dependencies are installed
        run: |
          if [ ! -d "node_modules" ]; then
            echo "node_modules directory not found"
            exit 1
          fi
          echo "✅ Dependencies installed"

      - name: Verify outputs
        run: |
          echo "Node version: ${{ steps.prepare.outputs.node-version }}"
          echo "Yarn version: ${{ steps.prepare.outputs.yarn-version }}"
          echo "Cache hit: ${{ steps.prepare.outputs.cache-hit }}"
          echo "Yarn cache dir: ${{ steps.prepare.outputs.yarn-cache-dir }}"
          echo "Install duration: ${{ steps.prepare.outputs.install-duration }}s"

      - name: Run format check
        run: yarn fmt:check

  # Matrix testing: different OS and Node versions
  test-matrix:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: ['20.x', '22.x', '24.x', 'latest']
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run prepare action
        id: prepare
        uses: ./actions/prepare
        with:
          node-version: ${{ matrix.node-version }}

      - name: Verify Node.js version
        shell: bash
        run: |
          version=$(node --version)
          echo "Installed Node.js: $version"
          echo "Output version: ${{ steps.prepare.outputs.node-version }}"

      - name: Verify Yarn is installed
        shell: bash
        run: |
          version=$(yarn --version)
          echo "Installed Yarn: $version"

      - name: Verify dependencies
        shell: bash
        run: |
          if [ ! -d "node_modules" ]; then
            echo "❌ node_modules not found"
            exit 1
          fi
          echo "✅ Dependencies installed"

  # Test: Cache disabled
  test-no-cache:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run prepare action without cache
        id: prepare
        uses: ./actions/prepare
        with:
          enable-cache: 'false'

      - name: Verify cache was disabled
        run: |
          cache_hit="${{ steps.prepare.outputs.cache-hit }}"
          if [[ -n "$cache_hit" ]]; then
            echo "❌ Cache should be empty when disabled"
            exit 1
          fi
          echo "✅ Cache correctly disabled"

      - name: Verify dependencies installed
        run: |
          if [ ! -d "node_modules" ]; then
            echo "❌ Dependencies should be installed"
            exit 1
          fi
          echo "✅ Dependencies installed without cache"

  # Test: Skip dependency installation
  test-no-install:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run prepare action without installing dependencies
        uses: ./actions/prepare
        with:
          install-dependencies: 'false'

      - name: Verify dependencies not installed
        run: |
          if [ -d "node_modules" ]; then
            echo "⚠️ node_modules exists (may be from cache)"
          else
            echo "✅ Dependencies not installed as expected"
          fi

      - name: Verify tools installed
        run: |
          node --version
          yarn --version
          echo "✅ Node and Yarn installed successfully"

  # Test: Custom Node and Yarn versions
  test-custom-versions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run prepare action with custom versions
        id: prepare
        uses: ./actions/prepare
        with:
          node-version: '20.18.1'
          yarn-version: '4.12.0'

      - name: Verify Node version
        run: |
          version=$(node --version)
          if [[ "$version" != "v20.18.1" ]]; then
            echo "Expected Node v20.18.1, got $version"
            exit 1
          fi
          echo "✅ Node version correct: $version"

      - name: Verify Yarn version
        run: |
          version=$(yarn --version)
          if [[ "$version" != "4.12.0" ]]; then
            echo "Expected Yarn 4.12.0, got $version"
            exit 1
          fi
          echo "✅ Yarn version correct: $version"

  # Test: Cache hit on second run
  test-cache-hit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: First run (cache miss expected)
        id: first-run
        uses: ./actions/prepare

      - name: Verify first run
        run: |
          echo "First run cache hit: ${{ steps.first-run.outputs.cache-hit }}"
          echo "First run duration: ${{ steps.first-run.outputs.install-duration }}s"

      - name: Clear node_modules to test cache
        run: rm -rf node_modules

      - name: Second run (cache hit expected)
        id: second-run
        uses: ./actions/prepare

      - name: Verify cache was used
        run: |
          cache_hit="${{ steps.second-run.outputs.cache-hit }}"
          if [[ "$cache_hit" != "true" ]]; then
            echo "⚠️ Expected cache hit, got: $cache_hit"
          else
            echo "✅ Cache hit successful"
          fi
          echo "Second run duration: ${{ steps.second-run.outputs.install-duration }}s"
